name: Anonymous Passwordless SSH Server with Bore.pub

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  ssh-server:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Install SSH Server and Rust
      run: |
        sudo apt-get update
        sudo apt-get install -y openssh-server curl build-essential
        
        # Install Rust and Cargo
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source $HOME/.cargo/env
        
    - name: Install Bore CLI using Cargo
      run: |
        source $HOME/.cargo/env
        cargo install bore-cli
        
    - name: Configure Passwordless SSH Server
      run: |
        # Backup original SSH config
        sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup
        
        # Configure SSH for NO authentication
        sudo tee /etc/ssh/sshd_config > /dev/null <<EOF
        Port 22
        Protocol 2
        
        # Disable all authentication methods
        PasswordAuthentication no
        PubkeyAuthentication no
        ChallengeResponseAuthentication no
        UsePAM no
        
        # Allow empty passwords and permit root login
        PermitRootLogin yes
        PermitEmptyPasswords yes
        
        # Disable strict modes for anonymous access
        StrictModes no
        
        # Allow anyone to connect
        AllowUsers *
        
        # Disable host key checking warnings
        LogLevel QUIET
        
        # Other settings
        X11Forwarding yes
        PrintMotd yes
        Subsystem sftp /usr/lib/openssh/sftp-server
        EOF
        
    - name: Create Users with Empty Passwords
      run: |
        # Set empty password for root
        sudo passwd -d root
        
        # Create topuser with empty password
        sudo useradd -m -s /bin/bash topuser
        sudo passwd -d topuser
        
        # Add topuser to sudo group
        sudo usermod -aG sudo topuser
        
    - name: Configure Anonymous Access
      run: |
        # Allow password-less sudo for topuser
        echo 'topuser ALL=(ALL) NOPASSWD: ALL' | sudo tee /etc/sudoers.d/topuser
        sudo chmod 440 /etc/sudoers.d/topuser
        
    - name: Start SSH Service
      run: |
        # Generate SSH host keys
        sudo ssh-keygen -A
        
        # Start SSH service
        sudo service ssh start
        sudo service ssh status
        
    - name: Create Connection Banner
      run: |
        sudo tee /etc/motd > /dev/null <<EOF
        ==========================================
        üîì ANONYMOUS SSH SERVER via Bore.pub üîì
        ==========================================
        
        Available Users (NO PASSWORD REQUIRED):
        ‚Ä¢ root
        ‚Ä¢ topuser (has sudo access)
        
        Just connect with: ssh username@[bore-url]
        No password needed - press Enter when prompted
        ==========================================
        EOF
        
    - name: Start Bore Tunnel and Display Connection Info
      run: |
        source $HOME/.cargo/env
        echo "üöÄ Starting bore tunnel for SSH..."
        
        # Start bore tunnel in background and capture output
        timeout 300 $HOME/.cargo/bin/bore local 22 --to bore.pub > bore_output.txt 2>&1 &
        BORE_PID=$!
        
        # Wait for connection to establish
        sleep 15
        
        # Display connection information
        echo "========================================"
        echo "üéØ SSH SERVER IS READY!"
        echo "========================================"
        
        if [ -f bore_output.txt ]; then
          # Extract port from bore output
          TUNNEL_INFO=$(cat bore_output.txt)
          echo "üìÑ Bore Output:"
          cat bore_output.txt
          echo ""
          
          # Try to extract port number
          TUNNEL_PORT=$(echo "$TUNNEL_INFO" | grep -oP 'bore\.pub:\K\d+' || echo "")
          if [ ! -z "$TUNNEL_PORT" ]; then
            echo "üåê SSH Connection Commands:"
            echo "   ssh root@bore.pub -p $TUNNEL_PORT"
            echo "   ssh topuser@bore.pub -p $TUNNEL_PORT"
            echo ""
            echo "üí° No password required - just press Enter when prompted!"
          else
            echo "‚ö†Ô∏è  Could not extract port number. Check output above."
          fi
        else
          echo "‚ö†Ô∏è  Bore output file not found."
        fi
        
        echo "========================================"
        echo "üìã Server Details:"
        echo "   ‚Ä¢ OS: $(lsb_release -d | cut -f2)"
        echo "   ‚Ä¢ Users: root, topuser (passwordless)"
        echo "   ‚Ä¢ Tunnel: Active via bore.pub"
        echo "   ‚Ä¢ Bore Path: $HOME/.cargo/bin/bore"
        echo "========================================"
        
        # Keep the workflow running for 6 hours
        echo "üîÑ Keeping server alive for 6 hours..."
        sleep 21600
